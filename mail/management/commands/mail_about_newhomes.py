# coding: utf-8
import pynliner
from django.conf import settings
from django.core.mail import EmailMessage
from django.core.management.base import BaseCommand
from django.template.loader import render_to_string
from django.utils import translation

from custom_user.models import User


class Command(BaseCommand):
    help = 'Sends mails about landing for april'

    def add_arguments(self, parser):
        parser.add_argument('--test-users', dest='test_users', nargs='+', type=int)
        parser.add_argument('--start-from-user', dest='start_from_user', nargs='?', type=int)

    def handle(self, **options):
        translation.activate('ru')

        if 'test_users' in options and options['test_users']:
            users_query = User.objects.filter(id__in=options['test_users'])

        else:
            # Список пользователей по условиям
            # ads__deal_type='newhomes', ads__status=1, is_active=True, subscribe_news=True, email__gt=''
            users_query = User.objects.filter(
                id__in=[59, 628, 646, 745, 775, 1467, 1596, 1714, 2249, 2579, 2854, 3670, 4412, 6180, 6821, 9061, 9324,
                        9346, 9628, 9663, 10199, 10444, 10801, 10961, 11094, 11105, 11586, 11920, 12181, 13084, 13271,
                        13302, 13659, 14299, 14351, 14618, 14759, 15130, 15964, 17534, 17601, 17693, 17809, 17813,
                        17882, 18393, 18477, 18569, 18705, 18766, 18817, 18887, 18917, 18992, 19260, 19299, 19335,
                        19504, 19659, 19711, 19831, 19839, 19863, 20140, 20228, 20273, 20279, 20379, 20425, 20683,
                        20706, 20724, 20731, 20812, 20826, 21082, 21130, 21147, 21220, 21318, 21320, 21619, 21637,
                        22114, 22206, 22245, 22356, 22374, 22406, 22421, 22423, 22449, 22523, 22609, 22732, 22955,
                        23081, 23228, 23452, 23689, 23856, 23861, 23970, 24171, 24254, 24308, 25187, 25191, 25680,
                        25706, 26202, 26410, 26590, 26687, 27193, 28068, 28082, 28117, 28342, 28359, 28361, 28412,
                        28653, 28715, 28866, 28869, 28884, 28967, 28976, 28999, 29008, 29033, 29165, 29262, 29316,
                        29371, 29436, 29582, 29662, 29722, 29798, 29834, 29852, 29885, 29913, 30564, 30569, 30674,
                        30783, 30957, 30977, 31008, 31063, 31076, 31097, 31159, 31317, 31456, 31677, 31687, 31889,
                        31895, 31919, 32012, 32071, 32118, 32201, 32374, 32484, 32724, 32789, 32919, 33352, 33482,
                        33659, 33916, 34012, 34250, 34319, 34347, 34353, 34501, 34549, 34564, 34821, 34867, 34927,
                        35080, 35111, 35407, 35778, 36104, 36130, 36201, 36420, 36523, 36551, 36769, 37125, 37197,
                        37318, 37324, 37406, 37505, 37662, 37766, 37860, 37935, 37949, 38016, 38022, 38094, 38253,
                        38272, 38409, 38422, 38436, 38459, 38469, 38517, 38549, 38591, 38730, 38738, 38785, 38812,
                        38860, 38867, 39163, 39320, 39826, 39872, 39920, 39945, 40093, 40275, 40276, 40510, 40512,
                        40516, 40524, 40525, 40528, 40627, 40662, 40743, 40761, 40773, 40796, 40849, 40870, 41100,
                        41192, 41196, 41208, 41230, 41254, 41278, 41298, 41343, 41345, 41350, 41358, 41372, 41400,
                        41469, 41470, 41500, 41506, 41564, 41592, 41594, 41612, 41626, 41628, 41650, 41727, 41728,
                        41813, 41854, 41860, 42067, 42085, 42091, 42179, 42216, 42329, 42431, 42522, 42530, 42734,
                        42902, 42921, 42967, 43053, 43055, 43204, 43450, 43531, 43534, 43626, 43638, 43750, 43785,
                        43788, 43814, 43842, 43865, 43946, 43965, 44003, 44152, 44170, 44460, 44532, 44573, 44690,
                        44717, 44730, 44854, 44895, 44907, 44975, 45012, 45031, 45045, 45187, 45225, 45551, 45618,
                        45757, 45968, 46010, 46170, 46187, 46253, 46683, 46721, 46886, 46929, 47015, 47024, 47088,
                        47274, 47358, 47459, 47506, 47581, 47598, 47617, 47686, 47740, 47780, 47790, 47805, 47834,
                        47843, 47844, 47870, 47923, 48025, 48073, 48091, 48186, 48210, 48419, 48444, 48585, 48708,
                        48736, 48739, 48770, 48950, 49006, 49017, 49197, 49290, 49297, 49404, 49448, 49494, 49528,
                        49598, 49676, 49826, 49912, 50156, 50214, 50234, 50263, 50278, 50365, 50405, 50428, 50500,
                        50512, 50526, 50529, 50575, 50590, 50701, 50718, 50756, 50772, 50844, 50848, 50879, 50927,
                        50982, 50984, 50994, 50995, 51012, 51150, 51323, 51423, 51470, 51511, 51625, 51827, 51840,
                        51954, 52131, 52185, 52254, 52306, 52450, 52609, 52631, 52681, 53019, 53051, 53132, 53161,
                        53257, 53533, 53729, 53753, 53802, 53928, 53977, 54183, 54362, 54458, 54465, 54615, 54624,
                        54738, 54898, 54928, 54934, 55042, 55076, 55443, 55549, 55581, 55643, 55717, 55925, 56046,
                        56219, 56298, 56352, 56379, 56496, 56683, 56818, 56821, 57027, 57099, 57115, 57185, 57211,
                        57243, 57256, 57260, 57280, 57311, 57431, 57586, 57738, 57832, 57854, 58016, 58037, 58112,
                        58322, 58430, 58482, 58484, 58494, 58537, 58540, 58650, 59022, 59140, 59261, 59300, 59316,
                        59587, 59689, 59696, 59734, 59936, 59966, 60053, 60075, 60099, 60129, 60314, 60344, 60357,
                        60415, 60441, 60489, 60630, 60812, 60961, 60972, 60986, 61005, 61521, 61643, 61706, 61846,
                        61885, 61990, 62572, 63077, 63093, 63094, 63109, 63494, 63546, 64100, 64250, 64382, 64498,
                        64656, 64948, 65023, 65544, 65749, 65931, 66339, 66490, 66624, 66641, 66695, 66799, 66805,
                        67098, 67111, 67153, 67465, 67648, 67838, 67870, 68252, 68389, 68616, 68816, 68821, 68876,
                        68970, 68992, 69030, 69356, 69357, 69515, 69524, 69582, 69677, 69714, 69888, 69899, 69931,
                        70095, 70138, 70189, 70621, 70644, 70681, 70797, 70817, 70819, 71186, 71296, 71309, 71340,
                        71344, 71346, 71534, 71608, 71777, 71785, 71837, 71871, 71877, 71920, 71988, 72064, 72093,
                        72101, 72203, 72762, 72797, 72970, 73063, 73212, 73218, 73264, 73304, 73459, 73584, 73585,
                        74132, 74296, 74379, 74515, 74563, 74602, 74794, 74936, 74981, 75115, 75440, 75460, 75500,
                        75563, 75675, 75726, 75889, 75900, 76188, 76192, 76216, 76272, 76393, 76915, 77138, 77169,
                        77391, 77405, 77502, 77677, 77736, 77829, 77889, 77926, 77941, 77951, 78003, 78025, 78140,
                        78530, 78590, 78630, 78643, 78775, 78834, 78914, 79111, 79153, 79440, 79513, 79773, 79783,
                        80003, 80198, 80220, 80354, 80373, 80431, 80664, 81025, 81026, 81028, 81029, 81032, 81051,
                        81072, 81326, 81343, 81633, 81662, 81950, 82074, 82134, 82206, 82437, 82444, 82765, 82866,
                        83081, 83222, 83258, 83275, 83316, 83419, 83489, 83667, 83684, 83750, 83815, 83967, 84062,
                        84079, 84250, 84917, 85154, 85168, 85310, 85405, 85458, 85580, 85614, 85791, 86279, 86297,
                        86385, 86624, 86891, 86952, 87554, 87761, 87825, 87903, 88011, 88207, 88458, 88522, 88573,
                        88736, 88738, 88797, 88949, 89172, 89182, 89199, 89227, 89244, 89256, 89501, 89670, 89682,
                        89749, 89751, 89797, 89888, 89976, 90122, 90266, 90281, 90540, 90612, 90701, 90844, 90897,
                        91273, 91302, 91305, 91365, 91450, 92114, 92229, 92254, 92340, 92390, 92402, 92427, 92448,
                        92450, 92467, 92580, 92609, 93094, 93277, 93288, 93609, 93616, 93646, 93883, 93889, 94089,
                        94096, 94711, 95167, 95174, 95188, 95412, 95569, 96204, 96550, 97158, 97171, 97189, 97199,
                        97933, 98005, 98262, 98596, 98604, 98686, 98816, 98920, 99189, 99197, 99252, 99290, 99616,
                        99627, 99673, 99792, 99812, 100014, 100169, 100705, 100810, 100870, 100885, 100895, 100898,
                        101086, 101129, 101145, 101179, 101206, 101224, 101376, 101382, 101512, 101653, 101702, 101715,
                        101747, 101967, 102145, 102342, 102548, 102599, 102706, 102728, 102749, 102752, 102888, 102935,
                        103040, 103059, 103102, 103180, 103271, 103572, 103651, 103655, 103713, 103809, 103820, 103822,
                        103954, 104342, 104420, 104785, 104846, 104866, 105057, 105083, 105195, 105325, 105381, 105489,
                        105685, 105689, 105764, 105846, 106299, 106403, 106662, 106854, 106887, 107064, 107316, 107517,
                        107635, 107766, 107911, 107923, 107935, 108111, 108125, 108178, 108288, 108309, 108338, 108566,
                        108575, 108598, 108626, 108862, 108914, 108947, 109176, 109193, 109319, 109389, 109412, 109431,
                        109477, 109522, 109696, 109806, 109961, 110063, 110096, 110098, 110114, 110338, 110446, 110474,
                        110497, 110720, 110724, 110819, 110839, 110855, 111297, 111307, 111403, 111478, 111542, 111643,
                        111678, 111820, 111858, 111894, 112093, 112115, 112167, 112321, 112426, 112429, 112431, 112449,
                        112580, 112649, 112664, 112685, 112763, 112777, 113060, 113235, 113457, 113475, 113503, 113611,
                        113719, 113765, 113769, 114174, 114242, 114287, 114325, 114439, 114545, 114702, 114771, 114869,
                        114931, 114950, 114977, 115075, 115088, 115115, 115148, 115157, 115175, 115181, 115204, 115365,
                        115369, 115390, 115426]
            ).distinct().order_by('id')
            if options['start_from_user']:
                users_query = users_query.filter(id__gte=options['start_from_user'])

        content = render_to_string('mail/mailing/mail_about_newhomes.jinja.html', {})
        content_with_inline_css = pynliner.fromString(content)

        for user in users_query:
            print 'user #%d' % user.id
            message = EmailMessage(
                u'Новый раздел "Новостройки"', content_with_inline_css,
                settings.DEFAULT_FROM_EMAIL, to=[user.email]
            )
            message.content_subtype = 'html'
            message.send()