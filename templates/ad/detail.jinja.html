{% extends 'base.jinja.html' %}

{% block extra_css %}
    <link rel="stylesheet" type="text/css" href="{{ static("libs/slick/slick.css") }}"/>
    <link rel="stylesheet" type="text/css" href="{{ static("libs/slick/slick-theme.css") }}"/>
    <link rel="stylesheet" href="{{ static('libs/bootstrap-select/bootstrap-select.min.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ static("newhome/css/newhome.css") }}"/>
{% endblock %}

{% block analysis %}
    {% include 'paid_services/analysis_pagebg.jinja.html' %}
{% endblock %}

{% block content %}
    {% with
        deal_types = { 'rent': _('Арендовать'), 'sale': _('Купить'), 'rent_daily': _('Снять посуточно'), 'newhomes': _('Купить в новостройке') },
        property_types = { 'flat': _('квартиру'), 'room': _('комнату'), 'house': _('дом'), 'plot': _('участок'), 'commercial': _('коммерческую недвижимость'), 'garages': _('гараж') }
    %}
        <noindex>
        <ol class="breadcrumb breadcrumb-detail">
            <li class="active">
                <a rel="nofollow" href="{{ related_search_url }}">
                    <i class="glyphicon glyphicon-chevron-left"></i>
                    {{ deal_types[item.deal_type] }} {{ property_types[item.property_type] }}
                    {% if item.region.kind == 'street' %}на{% else %}в{% endif %} {{ item.region.nameD['gde'] }}
                    {% if item.rooms %}с {{ item.rooms|pluralize((_("комнатой"), _("комнатами"), _("комнатами")), '') }}{% endif %}
                    за {{ related_query_dict.local_price_from|intcomma }}  &mdash; {{ related_query_dict.local_price_to|intcomma }} {{ item.get_currency_display() }}
                    </a>
                {# TODO: брать из формы поиска и передавать в параметрах при переходе на страницу объявления:  #}
            </li>
        </ol>
        </noindex>
    {% endwith %}


  {% if item.newhome_layouts.exists() %}
    {# Подгружаем отдельный шаблон для новостроек #}
    {% include "newhome/ad-detail.jinja.html" %}

  {% else %}
    {# Обычное отображение объявлений #}
    <div class="row">
        <div class="col-lg-18">
            {% if shown_only_for_you is defined %}
                <div class="alert alert-danger">
                    Это объявление скрыто от остальных пользователей, т.к.
                        {% if item.moderation_status %}
                            было отклонено: <b>{{ item.get_moderation_status_display() }}</b>
                        {%- elif item.status != 1 -%}
                            имеет статус <b>{{ item.get_status_display() }}</b>
                        {%- endif -%}
                        .<br/>
                    Вы можете поменять статус объявления в личном кабинете или отредактировать его, если объявление было отклонено по определенной причине.
                </div>
            {% endif %}

            <div class="property-detail hidden-contacts white-panel" id="property-detail" itemscope itemtype="http://schema.org/Place"
                 data-id='{{ item.pk }}' data-dealtype='{{ item.get_deal_type_display()|title }}' >
                <p class="created"><i class="icon icon-date"></i> {% trans %}Дата публикации{% endtrans %}:
                    <small>
                    {% if item.user %}
                        {{ item.updated|date("d.m.Y") }}
                    {% else %}
                        {{ item.modified|date("d.m.Y") }}
                    {% endif %}
                    </small>
                </p>

                <div class="row property-header">
                    <div class="col-sm-14">
                        <h1>{{ item }}
                            {% if request.user.is_authenticated() -%}
                                <a href="{{ url('profile_save_property', item.pk) }}" class="to-favorite hidden-print"
                                    title="{% trans %}добавить в избранное{% endtrans %}"><i class="icon icon-favorite{% if item.is_favorite(request.user) %} icon-favorite-active{% endif %}"></i></a>
                            {%- else -%}
                                <a data-target="#login-popup"  data-toggle="modal"
                                    title='{% trans %}Получи еще больше возможностей на сайте. Жми кнопку "зарегистрироваться"{% endtrans %}' class="to-favorite hidden-print default-tooltip"><i class="icon icon-favorite"></i></a>
                            {%- endif %}

                            {% if request.user.is_authenticated() and request.user == item.user %}
                                <a href="{{ url('profile_edit_property', item.pk) }}"
                                   title="{% trans %}редактировать объявление{% endtrans %}" class="btn btn-default btn-sm hidden-print">
                                    <i class="glyphicon glyphicon-pencil"></i>
                                </a>
                            {% endif %}
                        </h1>
                        <div class="deal-type">{{ item.get_deal_type_display()|capitalize }}, {{ item.get_property_type_display() }}, ID {{ item.id|stringformat("08d") }} </div>
                    </div>
                    <div class="col-sm-10">
                        <div class="price-converted">
                            {% for currency in ( ( 'UAH', 'грн.'), ('USD', '$'), ('EUR', '&euro;') ) %}
                                {% if currency.0 != item.currency %}
                                    ~ {{ item.get_converted_price(currency.0, None, True)|intcomma }}
                                    {{ currency.1|safe }}<br/>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <div class="price{% if item.is_bargain_possible %} bargain-possible{% endif %}">
                            <b><span class="big">{{ item.price|intcomma }}</span> {{ item.get_currency_display() }}
                            </b> {% if item.price_period %}{{ item.price_period }}{% endif %}{% if item.is_bargain_possible %}<span class="bargain-info">возможен торг</span>{% endif %}
                        </div>
                        <div class="clearfix"></div>
                    </div>
                </div>

                <div class="row property-content">

                    <div class="col-sm-12 col-sm-push-12 gallery">
                      {# Макрос перенесен, т.к. вскоре общие блоки с шаблоном newhome/ad-detail.jinja.html будут вынесены #}
                      {% macro render_big_image(item, photo, show_new_gallery=False) %}
                        <figure itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject" class="image-item">
                          <a href="{{ photo.smart_thumbnail("full") }}" rel="gallery" title="{{ photo.caption|default('') }}" itemprop="contentUrl" {% if show_new_gallery %}data-size="{{ photo.width }}x{{ photo.height }}"{% else %}class='js_big_image_wrap'{% endif %}>
                            <img src="{{ photo.smart_thumbnail("lg") }}" title="{{ item.image_title }}" itemprop="thumbnail" class="img-responsive"/>
                          </a>
                        </figure>
                      {% endmacro %}

                      {% with coords = item.get_coords(), property_photos = item.photos.all() %}

                        <ul class="nav nav-pills" role="tablist">
                          {% if item.iframe_url %}
                            <li role="presentation" class="btn-360"><a href="#tab-iframe" role="tab" data-toggle="tab"
                               data-status-bar="{% trans %}360 панорама{% endtrans %}" title="{% trans %}360 панорама{% endtrans %}"></a></li>
                          {% endif %}
                          {% if property_photos %}
                            <li role="presentation" class="btn-photos"><a href="#tab-photos" role="tab" data-toggle="tab"></a></li>
                          {% endif %}
                          {% if coords %}
                            <li role="presentation" class="btn-map"><a href="#tab-map" role="tab" data-toggle="tab"
                               data-status-bar="{{ item.address }}" title="{% trans %}карта{% endtrans %}"></a></li>
                          {% endif %}
                        </ul>

                        <div class="tab-content">
                          {% if item.iframe_url %}
                            <div role="tabpanel" class="tab-pane" id="tab-iframe">
                              <iframe src="{{ item.iframe_url }}" frameborder="0" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>
                            </div>
                          {% endif %}

                          {% if property_photos %}
                            <div role="tabpanel" class="tab-pane images" id="tab-photos">
                              {% if item.has_deactivation_reason() %}
                                <span class="sold-label">{% trans %}Продано{% endtrans %}</span>
                              {% endif %}

                              {# fixme: Во время перехода между галереями нужна проверка на наличие у всех изображений полей с размерами #}
                              {% set photo_without_dimensions = [] %}
                              {% for photo in property_photos %}
                                {% if not photo.width or not photo.height %}
                                  {% do photo_without_dimensions.append(photo.id) %}
                                {% endif %}
                              {% endfor %}
                              <div class="mst_scroll_big_image js_scroll_big_image{% if not photo_without_dimensions %} pswp-gallery{% endif %}" itemscope itemtype="http://schema.org/ImageGallery">
                                {% for photo in property_photos %}
                                  {% if not photo_without_dimensions %}
                                    {{ render_big_image(item, photo, True) }}
                                  {% else %}
                                    {{ render_big_image(item, photo) }}
                                  {% endif %}
                                {% endfor %}
                              </div>

                              <div class="clearfix"></div>
                            </div>
                          {% endif %}

                          {% if coords %}
                            <div role="tabpanel" class="tab-pane" id="tab-map">
                              <div id='local-info-n-map' class='ui-tabs-hide' itemprop="geo" itemscope itemtype="http://schema.org/GeoCoordinates">
                                <meta itemprop="longitude" content="{{ coords[0] }}"/>
                                <meta itemprop="latitude" content="{{ coords[1] }}"/>
                                <link rel="stylesheet" href="{{ static('libs/leaflet/leaflet.css') }}">
                                <div id='embed_map' style='width:100%;'
                                   data-js="{{ static('libs/leaflet/leaflet.js') }}"
                                   data-lon='{{ coords[0] }}' data-lat='{{ coords[1] }}'
                                   data-lang-code="{{ {'uk': 'uk-UA', 'ru': 'ru-RU'}[LANGUAGE_CODE] }}">
                                  <div class='content hidden'><p>{{ item.address|linebreaksbr }}</p>
                                      Цена: {{ item.price|intcomma }} {{ item.get_currency_display() }}</div>
                                </div>
                              </div>
                            </div>
                          {% endif %}
                        </div>

                        <div class="status-bar">
                          <div class="row">
                              <div class="col-xs-2 photo-counter"></div>
                              <div class="col-xs-20 text-center name"></div>
                              <div class="col-xs-2 text-right"><span class="fullscreen" href="#"><i class="glyphicon glyphicon-fullscreen float-right show-in-fullscreen"></i></span></div>
                          </div>
                          <div class="modal fade" id="modal-fullscreen" tabindex="-1" role="dialog">
                            <div class="modal-dialog modal-lg" role="document">
                              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                              <div class="modal-content"></div>
                            </div>
                          </div>
                        </div>
                      {% endwith %}
                    </div>

                    <div class="col-sm-12 col-sm-pull-12">
                        {% if item.rooms or item.area or item.floor %}
                            <div class="info-1">
                                <table class="table table-striped">
                                    <tr align="center">
                                        {% if item.rooms %}
                                            <td>{{ item.rooms|pluralize((_("комната"), _("комнаты"), _("комнат")), '') }}</td>
                                        {% endif %}
                                        {% if item.area %}
                                            <td>
                                                {% if item.property_type == 'plot' %}
                                                    {{ item.area|pluralize((_("сотка"), _("сотки"), _("соток")), '')  }}
                                                {% else %}
                                                    {{ item.area|floatformat }} м<sup>2</sup>
                                                {% endif %}
                                            </td>
                                        {% endif %}
                                        {% if item.floor %}
                                            <td>{{ item.floor }}-й этаж
                                                {% if item.floors_total %}из {{ item.floors_total }}{% endif %}
                                            </td>
                                        {% elif item.floors_total %}
                                            <td>{{ item.floors_total|pluralize((_("этаж"), _("этажа"), _("этажей")), '')  }}</td>
                                        {% endif %}
                                        {% if item.building_type  %}
                                            {% if item.building_type == 200  %}
                                                <td>{{ item.building_type_other }}</td>
                                            {% else %}
                                                <td>{{ item.get_building_type_display() }}</td>
                                            {% endif %}
                                        {% endif %}
                                    </tr>
                                </table>
                            </div>
                        {% endif %}

                        {% if item.has_deactivation_reason() %}
                            <p class="dashed-panel text-center sold-info">
                                {% trans %}<b>Этот объект продан.</b><br/> Пожалуйста, свяжитесь с риелтором, чтобы найти похожий вариант объекта.{% endtrans %}
                            </p>
                        {% endif %}

                    <div class="usercard">
                        <div class="row">
                            <div class="col-sm-15">
                                {% if usercard.get('contact_person') %}
                                    <p>
                                        <i class="glyphicon glyphicon-user"></i>
                                        {% if 'all_ads_button' in usercard %}
                                            <a href='{{ usercard.all_ads_button.0 }}'>{{ usercard.contact_person }}</a>
                                        {% else %}
                                            {{ usercard.contact_person }}
                                        {% endif %}
                                    </p>
                                {% endif %}

                                <form class="contacts" action="{{ url('ad-contacts',
                                        deal_type=deal_type, region_slug=region_slug, id=item.pk) }}">
                                    {% csrf_token %}

                                    {% if (not usercard.get('phone_for_lead') and usercard.phone) or usercard.get('skype') or usercard.get('email') %}
                                        <button class="show-contacts show-contacts-button" type='button' data-target="{{ item.get_deal_type_display()|title }}">
                                            <i class="caret"></i> <span>{% trans %}Узнать номер{% endtrans %}</span>
                                        </button>
                                    {% endif %}

                                    {% if usercard.phone %}
                                        <p class='phone'>
                                            <i class='glyphicon glyphicon-earphone' title='Телефон'></i>
                                            {% if usercard.get('phone_for_lead') %}
                                              {{ usercard.phone|pprint_phone|safe }}
                                            {% else %}
                                              <span>{{ usercard.phone|hide_contacts(item.get_deal_type_display()|title) }}</span>
                                            {% endif %}
                                            {% if usercard.get('phone_for_lead') %}
                                                <p><span class='id'>ID {{ item.id }}</span></p>
                                            {% endif %}
                                        </p>
                                    {% endif %}
                                    {% if usercard.get('skype') %}
                                        <noindex>
                                            <p class='skype'>
                                                <i class='glyphicon glyphicon-headphones' title='Skype'></i>
                                                <span>{{ usercard.skype|hide_contacts(item.get_deal_type_display()|title) }}</span>
                                            </p>
                                        </noindex>
                                    {% endif %}
                                    {% if usercard.get('email') %}
                                        <p class='email'>
                                            <i class='glyphicon glyphicon-envelope' title='E-mail'></i> <span>{{ usercard.email|hide_contacts(item.get_deal_type_display()|title) }}</span>
                                        </p>
                                    {% endif %}
                                    {% if usercard.get('phone_for_lead') %}
                                        {% if usercard.get('phone_with_callback') %}
                                            <p class="note">{% trans %}Звонки в пределах Украины бесплатны. Мы вам перезвоним. ID объявления нужно будет ввести при звонке для соединения с риелтором{% endtrans %}</p>
                                        {% elif usercard.get('phone_with_ivr') %}
                                            <p class="note">{% trans %}ID объявления нужно будет ввести при звонке для соединения с риелтором. Все звонки тарифицируются согласно тарифам Вашого оператора.{% endtrans %}</p>
                                        {% else %}
                                            <p class="note">{% trans %}Все звонки тарифицируются согласно тарифам Вашого оператора.{% endtrans %}</p>
                                        {% endif %}
                                    {% else %}
                                        <p class="note hidden">{% trans %}Для того, что бы продавец быстрее понял какой объект Вас интересует - скажите ему что нашли его на Mesto.ua{% endtrans %}</p>
                                    {% endif %}
                                </form>
                                {% if usercard.get('working_hours') %}
                                    <div>
                                        <i class='glyphicon glyphicon-time' title='Время работы'></i>
                                        {{ usercard.working_hours }}
                                    </div>
                                {% endif %}
                                {% if usercard.get('comment') %}
                                    <div class='usercard__comment'>{{ usercard.comment }}</div>
                                {% endif %}

                                <div class="clearfix hidden-print buttons">
                                    {% if contact_form is defined %}
                                        <a class="btn btn-bordered send-message2" data-toggle="modal" data-target="#international-message-modal">
                                            {% trans %}Связаться с владельцем{% endtrans %}
                                        </a>
                                        {% include 'ad/international_message.jinja.html' %}
                                    {% endif %}

                                    {% if usercard.get('show_message_button') %}
                                      <div>
                                        <a
                                            {% if request.user.is_authenticated() %}
                                                class='btn btn-bordered send-message ' href='{{ url('messages:about_property', property_id=item.id) }}?subject=details'
                                            {% else %}
                                                class='btn btn-bordered default-tooltip' data-toggle="modal" data-target="#login-popup"
                                                title='{% trans %}Получи еще больше возможностей на сайте. Жми кнопку "зарегистрироваться"{% endtrans %}'
                                            {% endif %}
                                            >{% trans %}Отправить сообщение{% endtrans %}</a> &nbsp;
                                        <a
                                            {% if request.user.is_authenticated() %}
                                                class='btn btn-bordered send-message ' href='{{ url('messages:about_property', property_id=item.id) }}?subject=counteroffer'
                                            {% else %}
                                                class='btn btn-bordered default-tooltip' data-toggle="modal" data-target="#login-popup"
                                                title='{% trans %}Получи еще больше возможностей на сайте. Жми кнопку "зарегистрироваться"{% endtrans %}'
                                            {% endif %}
                                            >{% trans %}Контроферта{% endtrans %}</a>
                                        {% include 'profile/messages/modal.jinja.html' %}
                                      </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-sm-9">
                                {% if item.user and item.user.is_asnu_member() %}
                                    {% if usercard.get('profile_image') %}
                                        <img class="asnu-logo" style="position:absolute;top:10px;right:10px;"
                                             src="{{ static('agency/img/icon-asnu.png') }}" width="50"
                                             alt="{% trans %}Ассоциация специалистов по недвижимости Украины{% endtrans %}"/>
                                    {% else %}
                                        <p class="text-right">
                                            <img class="asnu-logo}" src="{{ static('agency/img/icon-asnu.png') }}" width="70"
                                             alt="{% trans %}Ассоциация специалистов по недвижимости Украины{% endtrans %}"/>
                                        </p>
                                    {% endif %}
                                {% endif %}

                                {% if usercard.get('profile_image') %}
                                    <div class="image">
                                        {% if 'all_ads_button' in usercard %}
                                            <a href='{{ usercard.all_ads_button.0 }}'>
                                                <img src="{{ usercard.get('profile_image')|thumbnail("200x200", nocrop=True) }}" class="img-responsive "/>
                                            </a>
                                        {% else %}
                                            <img src="{{ usercard.get('profile_image')|thumbnail("200x200", nocrop=True) }}" class="img-responsive "/>
                                        {% endif %}
                                    </div>
                                {% endif %}

                                {% if 'all_ads_button' in usercard %}
                                  <div style="margin-top:10px;">
                                    <a class='btn btn-bordered btn-block' href='{{ usercard.all_ads_button.0 }}'
                                        >{{ usercard.all_ads_button.1 }}</a>
                                  </div>
                                {% endif %}
                            </div>
                        </div>

                        {% if callrequest_form is defined and callrequest_form %}
                            <div class="callrequest-panel {% if item.has_deactivation_reason() %} callrequest-panel-for-sold{% endif %}">
                                {% if item.has_deactivation_reason() %}
                                    <p>{% trans %}Заказав обратный звонок, риелтор будет знать по каким критериям Вы ищите объект и перезвонит вам{% endtrans %}</p>
                                {% endif %}
                                <a class="btn btn-danger btn-lg send-message2" data-toggle="modal" data-target="#callrequest-modal">
                                    {% trans %}Заказать обратный звонок{% endtrans %}
                                </a>
                                {% include 'ppc/callrequest_form.jinja.html' %}
                            </div>
                        {% endif %}
                    </div>

                        <ul class="nav nav-pills nav-pills-mesto" role="tablist">
                            <li class="active"><a href="#info" role="tab" data-toggle="pill"><span>{% trans %}Информация{% endtrans %}</span></a>
                            </li>
                            {% if reserved_dates is defined and reserved_dates  %}
                                <li><a href="#calendar" role="tab" data-toggle="pill"><span>{% trans %}Календарь{% endtrans %}</span></a></li>
                            {% endif %}
                        </ul>
                        <div class="tab-content">
                            {% macro show_field(label, value) %}
                                {% if value %}
                                    <tr>
                                        <td>{{ label }}:</td>
                                        <td>{{ value }}</td>
                                    </tr>
                                {% endif %}
                            {% endmacro %}

                            <div class="tab-pane active" id="info">
                                <table class="table table-striped">
                                    {{ show_field(_("Адрес"), item.addr_street ) }}
                                    {{ show_field(_("Комнат"), item.rooms ) }}
                                    {{ show_field(_("Спальных мест"), item.guests_limit ) }}
                                    {% if item.property_type != 'plot' %}
                                        {{ show_field(_("Площадь"), item.area|floatformat ) }}
                                        {{ show_field(_("Площадь жилая"), item.area_living|floatformat ) }}
                                        {{ show_field(_("Площадь кухни"), item.area_kitchen|floatformat ) }}
                                    {% else %}
                                        {{ show_field(_("Площадь в сотках"), item.area ) }}
                                    {% endif %}
                                    {{ show_field(_("Этаж"), item.floor) }}
                                    {{ show_field(_("Всего этажей"), item.floors_total) }}
                                    {{ show_field(_("Планировка"), item.get_building_layout_display() ) }}
                                    {{ show_field(_("Тип здания"), item.get_building_type_display()
                                                    if item.building_type != 200 else item.building_type_other) }}
                                    {{ show_field(_("Тип стен"), item.get_building_walls_display() ) }}
                                    {{ show_field(_("Тип окон"), item.get_building_windows_display() ) }}
                                    {{ show_field(_("Тип отопления"), item.get_building_heating_display() ) }}
                                    <tr>
                                        <td>{% trans %}Цена:{% endtrans %}</td>
                                        <td>{{ item.price }} {{ item.get_currency_display() }}</td>
                                    </tr>
                                  {% if item.without_commission %}
                                  <tr>
                                    <td>{% trans %}Комиссия:{% endtrans %}</td>
                                    <td>{% trans %}отсутствует{% endtrans %}</td>
                                  </tr>
                                  {% endif %}
                                </table>
                            </div>

                            {% macro show_checked_list(checked_objects, all_objects) %}
                                <div class="row">
                                    {% for column in all_objects | slice(4) -%}
                                        <div class=" col-sm-12 col-md-6">
                                            {% for object in column %}
                                                <p class="{{ object.__class__.__name__|lower() }}-{{ object.pk }}{% if object in checked_objects %} active{% endif %}">
                                                    {{ object }}</p>
                                            {% endfor %}
                                        </div>
                                        {% if loop.index == 2 %}<div class="clearfix hidden-md hidden-lg"></div>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endmacro %}

                            {% if reserved_dates is defined and reserved_dates %}
                                <div class="tab-pane " id="calendar">
                                    <link rel="stylesheet" href="{{ static('libs/bootstrap3-editable/css/bootstrap-editable-custom.css') }}">
                                    <script src="{{ static('libs/bootstrap-datepicker/js/bootstrap-datepicker.min.js') }}"></script>
                                    <script src="{{ static('libs/bootstrap-datepicker/locales/bootstrap-datepicker.ru.min.js') }}"></script>
                                    <script>
                                        $('#calendar')
                                            .datepicker({language: "ru", todayHighlight:true, multidate:true, format: "yyyy-mm-dd", beforeShowDay: function() {return false;}})
                                            .datepicker('setDates', {{ reserved_dates|to_json() }});
                                    </script>
                                    <br/><div class="row">
                                        <div class="col-xs-12 busy">
                                            &mdash; {% trans %}занято{% endtrans %}
                                        </div>
                                        <div class="col-xs-12 text-right">
                                            <small>{% trans %}календарь обновлен{% endtrans %} {{ item.modified_calendar|date("d.m.Y") }}</small>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                    </div>
                </div>

                {% if selected_facilties %}
                    <div id="facilities">
                        <div class="h2">{% trans %}Удобства{% endtrans %}</div>
                        <div class="facilities-list">
                            <div class="tab-pane facilities">
                                {{ show_checked_list(selected_facilties, selected_facilties[:12]) }}
                                {% if selected_facilties|length > 12 %}
                                    <a href="#facilities" class="hidden-toggle hidden-toggle-link">+ {% trans %}показать больше{% endtrans %}</a>
                                    <div class="hidden hidden-toggle">
                                        {{ show_checked_list(selected_facilties, selected_facilties[12:]) }}
                                        <a href="#facilities" class="hidden-toggle-link">^ {% trans %}свернуть{% endtrans %}</a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div><br/>
                {% endif %}

                {% if item.description %}
                    <div class="description">
                        <div class="h2">{% trans %}Описание{% endtrans %}</div>
                        {% if item.bank%}<div>{% trans %}ID объекта в базе{% endtrans %} {{ item.id }}.</div>{% endif %}
                        <div>{{ item.description|nl2br }}</div>
                        {% if item.bank%}<div>{% trans %}Работает call back телефония - мы вам перезвоним.{% endtrans %}</div>{% endif %}

                        {% if request.subdomain == 'harkov' and item.deal_type == 'rent' %}
                        <p><a href="//harkov.mesto.ua/guide/news/riski_moshenichestva/">{% trans %}Риски мошенничества при долгосрочной аренде{% endtrans %}</a></p>
                        {% endif %}
                    </div>
                {% endif %}

                {# social share #}
                <br/>
                {% include 'includes/social_share.jinja.html' %}

            </div>

            {% if request.user.is_staff %}
                <div class="alert alert-success fade in technical-info" role="alert">
                    <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                    <ul class="breadcrumb">
                        <b>{% trans %}Регион:{% endtrans %}</b>
                        {% for region in item.region.get_parents() %}
                            <li><a href="{{ region.get_deal_url(deal_type) }}">#{{ region.id }} {{ region.name }}</a></li>
                        {% endfor %}
                    </ul>
                    <div>
                        <p><b>{% trans %}Статус{% endtrans %}</b>: {{ item.get_status_display() }}</p>
                        <p><b>{% trans %}Редактировалось{% endtrans %}</b>: {{ item.modified|date("d.m.Y H:i") }} </p>
                        <p><b>{% trans %}Поднималось последний раз{% endtrans %}</b>: {{ item.updated|date("d.m.Y H:i") }}</p>
                        <p><b>{% trans %}Срок хранения объявления{% endtrans %}</b>: {{ item.expired|date("d.m.Y H:i") }}</p>
                        {% if item.is_exported_to_ria %}
                            <p><b>{% trans %}Экспорт на сайт DOM.RIA.COM{% endtrans %}</b>: ДА</p>
                        {% endif %}
                        {% if item.xml_id %}
                            <p>
                                <b>XML_ID</b>: {{ item.xml_id }}<br/>
                                <b>{% trans %}Источник{% endtrans %}</b>: <a href="{{ item.source_url }}">{{ item.source_url }}</a><br/>
                            </p>
                        {% endif %}
                        <p>
                            <a href="{{ url('admin:ad_ad_change', item.pk) }}" class="btn btn-danger">{% trans %}Редактировать объявление{% endtrans %}</a>
                            {% if item.user_id %}
                                <a href="{{ url('admin:ad_ad_changelist') }}?user__exact={{ item.user_id }}" class="btn btn-danger">{% trans %}Смотреть объявления пользователя{% endtrans %}</a>
                            {% else %}
                                <span class="btn btn-primary disabled ">{% trans %}Объявление из фида{% endtrans %}</span>
                            {% endif %}
                        </p>

                        {% if request.user.has_perm("%s.%s_%s" % ( 'ad', 'change', 'moderation')) %}
                          {% with ad = item, form_action = url('moderation_queue'), next = request.build_absolute_uri() %}
                            <h3>Модерация</h3>
                            {% include 'admin/moderation_form.jinja.html' %}
                          {% endwith %}

                          {% with moderations = item.moderations.all() %}
                            {% include 'admin/moderation_history.jinja.html'  %}
                          {% endwith %}
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
        <div class="col-lg-6 property-list-short visible-lg">
            {% with property = item, property_class = 'active' %}
                {% include "ad/preview-short.jinja.html" %}
            {% endwith %}
            {% for property in related_block['items'] %}
                {% include "ad/preview-short.jinja.html" %}
            {% endfor %}

            <div class="detail-banner visible-lg">
                {# баннер 300x600 #}
                {% with place_id = 12615 %}
                    {% include 'includes/banner_rontar.jinja.html' %}
                {% endwith %}
                {% with rontar_place_id=12615, z='3329de82-850c-42db-9f17-e5e190169010', ph='admixer_3329de82850c42db9f17e5e190169010_zone_10334_sect_2951_site_2705_rnd_862988554' %}
                    {% include 'includes/admixer_banner.jinja.html' %}
                {% endwith %}
            </div>
        </div>
    </div>
  {% endif %}
    <br/>
    <div class="page-info visible-lg hidden-print">
        {%  with breadcrumbs = region.get_breadcrumbs(item.deal_type, item.property_type, detail=True, current_language=request.LANGUAGE_CODE, rooms=item.rooms ) %}
            {% include "includes/breadcrumbs.jinja.html" %}<br/>
        {% endwith %}
    </div>

{% endblock %}

{% block footer_crosslinks %}
  {% if crosslinks_blocks is defined %}
    <div class="row visible-lg hidden-print">
      {% include 'includes/crosslink.jinja.html' %}
    </div>
  {% endif %}
{% endblock %}


{% block extra_footer %}
    <script type="text/javascript" src="{{ static("libs/slick/slick.min.js") }}"></script>

    <script src="{{ static('js/libs/humanize.min.js') }}"></script>
    <script>
        {% if item.deal_type == 'rent_daily' %}
            var reserved_json = {{ item.reserved_json().reserved|safe }};
            var calend_from, calend_to;
        {% endif %}

        $(function () {
            initPropertyGallery();
            InstallPropertyPage();
        });

        var brokenThumbnails = [];
        var thumbnails = $('.images img, .image-item img');
        thumbnails.one('error', function() {
            brokenThumbnails.push($(this));
        });
        $(window).on('load', function() {
            if(brokenThumbnails.length) {
                $.each(brokenThumbnails, function(index, img) {
                    img.attr('src', "{{ static('img/no-photo.png') }}");
                });
                $.get("{{ url('no_thumbnails') }}");
            }
        });
    </script>

    {% if item.newhome_layouts.exists() %}
      <script type="text/javascript" src="{{ static("newhome/js/newhome.js") }}"></script>
      <script type="text/javascript" src="{{ static('libs/bootstrap-select/bootstrap-select.min.js') }}"></script>
      <script>
        $().ready(function() {
          availableFlatsProcess();
        });
      </script>
    {% endif %}

    {# для includes/social_share.jinja.html #}
    <script type="text/javascript" src="//yastatic.net/es5-shims/0.0.2/es5-shims.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="//yastatic.net/share2/share.js" charset="utf-8"></script>
{% endblock %}

{% block extra_header %}
    {{- super() -}}
    {%- for photo in item.photos.all()[:10] -%}
        <link rel="image_src" href="{{ photo.smart_thumbnail('lg') }}"><meta property="og:image" content="{{ photo.smart_thumbnail('lg') }}" />
    {%- endfor -%}
{% endblock %}
